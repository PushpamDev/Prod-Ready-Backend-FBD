name: Deploy Scheduler Backend

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: SSH & Deploy
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: deploy
          key: ${{ secrets.BACKEND_SSH_KEY }}
          port: 22
          script_stop: true
          script: |
            set -e

            cd /home/deploy/apps/scheduler-backend

            echo "ğŸ“¥ Pulling latest code..."
            git fetch origin
            git reset --hard origin/main

            echo "ğŸ³ Building Docker image..."
            docker build -t scheduler-api .

            echo "ğŸ›‘ Stopping old container..."
            docker rm -f scheduler-api || true

            echo "ğŸš€ Starting new container..."
            docker run -d \
              --name scheduler-api \
              --restart always \
              -p 127.0.0.1:3000:3000 \
              --env-file .env \
              scheduler-api

            echo "âœ… Backend Deployment Completed"
